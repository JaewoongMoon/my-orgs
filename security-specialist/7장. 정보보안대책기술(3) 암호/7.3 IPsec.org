#+TITLE: IPsec

* IPsec의 개요
** IPsec을 이용한 거점간 접속에 의한 인터넷 VPN (IPsec VPN)

** IPsec을 이용한 거점대단말접속에 의한 인터넷 VPN (IPsec VPN)


* IPsec의 VPN에 있어서의 두 종류의 암호화 모드
** 트랜스포트 모드


** 터널 모드
- IP 헤더와 데이터 부분까지 캡슐화해서 암호화함
- 새로운 IP 헤더가 부여됨


* IPsec에 의해 제공되는 기능
** 접근제어 기능
- 패킷 필터 방식의 파이어월과 같은 기능 제공 가능

** 메세지 인증 기능
- MAC을 통해 메세지 변조 검출 가능

** 송신자 인증 기능
- MAC을 기반으로 데이터 송신자의 정당성을 확인가능

** 송신 데이터 중복 탐지 기능
- 데이터 도청에 의한 리플레이 어택을 방어 가능
- 리플레이 어택은 요새 비트코인 관련해서 이슈가 되고 있다. (비트코인 재분열)
- 리플레이 공격을 방어하는 원리는 무엇인가?
- IPSec의 서브 프로토콜인 Anti-replay 프로토콜은 매 패킷 시퀀스를 송신측/수신측에서 관리하고 있어서
- 동일한 값의 요청이라고 해도 패킷 시퀀스가 다르므로 중복해서 처리되지 않도록 하는 것 같다. 
- 따라서 리플레이 공격에 대한 방어가 되는 것이라고 이해된다. 

** 송신데이터(페이로드, 헤더 정보) 암호화 기능
- 트랜스포트 모드일 경우는 페이로드와 TCP 헤더만 암호화한다. 
- 터널모드일 경우에는 페이로드, TCP 헤더 + IP 헤더까지 암호화 가능

* IPsec을 구성하는 프로토콜과 기능의 개요
** SPD
- *Security Policy Database*
- 미리 패킷 처리에 관한 룰(셀렉터)을 SPD에 저장해두면 다음과 같은 제어가 가능해진다. 
1) 패킷 파기
2) IPsec 기능을 적용하지 않고 통과
3) IPsec 기능을 적용해서 처리

- 셀렉터는 패킷의 발신자 주소, 수신자 주소, 수신자 포트 번호, 프로토콜 종류 등을 토대로 다음과 같은 설정을 한다. 
1) IPsec의 적용 유무
2) 적용할 프로토콜 (AH, ESP)
3) 적용할 전송모드 (트랜스포트 모드, 터널 모드)
4) 암호 알고리즘
5) 메세지 인증 알고리즘

** SA
- *Security Association*
- IPsec에서 *논리적 연결* 을 의미함
- 제어용으로 쓰이는 *ISAKMP SA* 와, 실제로 통신 데이터를 보내기 위해 쓰이는 *IPsec SA* 가 있다. 
- IPsec 게이트웨이 사이에서 통신이 시작될 때, 최초 페이즈에서 제어용 ISAKMP SA가 만들어지고,
- 다음 페이즈에서 IPsec SA가 만들어진다. 
- ISAKMP SA는 IPsec 게이트웨어 사이에서 하나(보내기 받기 겸용)만들어지지만,
- IPsec SA는 통신을 하는 각 호스트사이에서 통신 방향이나 사용하는 프로토콜(AH, ESP) 별로 별도의 SA가 만들어진다. 
- IPsec SA를 식별하기 위한 정보로 수신측 IP 주소, 프로토콜 종류(AH, ESP), SPI(Security Parameter Index)가 사용된다.

** AH
- *Authentication Header, 인증헤더*
- 통신 데이터의 인증(메세지 인증)을 위해 사용하는 프로토콜
- 통신 데이터를 암호화하는 기능은 없다. 
- 메세지 인증 기능은 ESP에도 있기 때문에 암호화 통신이 주목적인 경우는 AH를 사용할 필요가 없다. 
- 트랜스 포트 모드의 경우 IP헤더와 TCP 헤더 사이에 AH 헤더가 삽입된다. 
- 터널 모드의 경우 원래 IP헤더와 VPN게이트웨이에 의해 새롭게 추가된 IP헤더 사이에 AH 헤더가 추가된다.
- AH 헤더의 인증 데이터 부분(가변길이)에 ICV(Integrity Check Value)가 세팅된다. 

** ESP
- *Encapsulating Security Payload, 암호화 페이로드*
- 통신 데이터의 인증(메세지 인증)과 암호화 양쪽의 기능을 제공하는 프로토콜
- ESP 에서는 AH와 다르게 트레일러라고 불리는 정보가 추가된다. 
- 트랜스 포트 모드의 경우 IP헤더와 TCP 헤더 사이에 ESP 헤더가 삽입되는 것과 함께, 페이로드 끝에 ESP 트레일러와 ICV가 추가된다.
- 터널 모드의 경우 원래 IP헤더와 VPN게이트웨이에 의해 새롭게 추가된 IP헤더 사이에 ESP 헤더가 삽입되는 것과 함께 , 페이로드 끝에 ESP 트레일러와 ICV가 추가된다.


** IKE
- *Internet Key Exchnage, 키 교환*
- SA 의 작성, 암호화에 사용되는 키의 교환등에 사용되는 프로토콜
- 버전1(IKEv1)과 버전2(IKEv2)가 있는데 양자간 호환성이 없기 때문에 IKEv1과 IKEv2간에 통신은 불가능하다.
- 여기서는 IKEv1에 대해서만 주로 설명한다. 
- IKEv1은 독립된 프로토콜로 UDP/500 포트를 사용한다.
- IKEv1은 SA와 키관리 사양을 규정한 *ISAKMP/Oakley* 를 구현한 범용적인 프로토콜이다.
- ISAKMP 는 Internet Security Association and Key Management Protol의 약자로 '이사캠프'로 읽거나 각각의 알파벳을 다 읽는다.
- IP헤더, UDP 헤더, ISAKMP 헤더, ISAKMP 페이로드 순으로 세팅된다. 
- IKEv1의 주요한 기능과 동작은 다음과 같다. 

*** 통신 상대 인증
다음 중 하나의 방법으로 통신 상대를 인증한다. 

| 순번 | 인증방법                            | 개요                                                                           |
|------+-------------------------------------+--------------------------------------------------------------------------------|
|    1 | 사전공유키인증(Pre-Shared Key 인증) | 송수신 양측이 사전에 공유한 키로 상대방을 인증. 가장 간단한 방법이며 널리 쓰임 |
|    2 | 디지탈 서명 인증                    | 상호 디지털 서명을 검증하는 것으로 상대를 인증하는 방식.                       |
|    3 | 공개키암호인증                      | 상대의 공개키를 입수해서 그 것으로 ID페이로드와 난수 페이로드를 암호화해서 송신 |
|    4 | 개량형공개키암호인증                | 공개키로는 난수 페이로드만 암호화하고  ID페이로드와 키교환 페이로드는 비밀대칭키로 암호화 |
|      |                                     |                                                                                           |

*** SA 작성과 관리
- IKEv1은 SA를 ISAKMP SA, IPsec SA 순서로 작성한다.
- 각 SA작성시에 패킷 교환방법에 따라 몇 가지 교환 타입이 있다. 
- 보통 ISAKMP SA작성에는 *메인모드* 나 *어그레시브 모드* 가,
- IPsec SA 작성에는 *퀵 모드* 가 사용된다.


*** SA 의 세 가지 모드
가장 일반적인 사전키 공유(Pre-Shared Key) 방식에 의한 인증시의 세 가지 모드에 대해 설명한다.

**** 메인 모드
- ISAKMP SA 작성에 사용된다. 
- 송신측(이니시에이터)과 수신측(리스폰더)이 다음 3번 왕복 패킷을 교환하는 것으로 ISAKMP SA 가 작성된다.

***** 네고시에이션 (교섭)
- 이니시에이터가 ISAKMP 파라메터(암호화 알고리즘, 해시 알고리즘, 인증방식 등)을 제안한다.
- 리스폰더는 그 중에서 수락가능한 파라메터를 선택한다. 

***** 비밀대칭키의 생성/교환
- 이니시에이터와 리스폰더가 Diffie-Hellman 키교환 알고리즘에 의해 비밀키(DH비밀키)를 공유한다.
- 그리고 이 비밀키를 토대로 다음 4개의 비밀대칭키를 생성한다.

****** SKEYID
다른 키를 생성하는 기초가 되는 키(사전공유키 인증이 경우에는 사전공유키로부터 생성)

****** SKEYID_d
IPsec SA에서 사용하는 비밀대칭키를 생성하는데 기초가 되는 키 (SKEYID, DH 비밀키등으로부터 생성)

****** SKEYID_a
ISAKMP 메세지 인증용 키 (SKEYID, SKEYID_d, DH 비밀키 등으로부터 생성)

****** SKEYID_e
이 후의 ISAKMP SA를 암호화하기 위한 비밀대칭키(SKEYID, SKEYID_d, DH 비밀키 등으로부터 생성)


***** 상대방 인증
- ID와 인증용 해시 값으로부터 상대방을 인증하고 ISAKMP SA 를 확립한다. 
- *ID와 인증용 해시값은 SKEYID_e에 의해 암호화된다.*

메인 모드 사용시 유의사항/제한
- 상대방을 인증하는 과정에서 ID를 교환하기 전에 비밀키의 교환을 통해 상대의 비밀키를 특정할 수 있어야 한다. 
- 이 것을 위해서는 통신 상대의 IP 주소를 사용할 수 밖에 없다. 
- *따라서 상대방 인증시  ID에는 IP 주소밖에 사용할 수 없다는 제약이 있다.* 
- *또한, 위의 특징에 따라 호스트의 IP가 매번 동적으로 바뀌는 환경(모바일환경등)에서는 사전 공유키를 특정할 수 없다.*
- *따라서 사전공유키인증에 의한 메인모드는 위와 같은 환경에서는 사용할 수 없다.*
- 위와 같은 환경에서는 다음에 설명할 어그레이스 모드를 사용하는 것이 일반적이다.



**** 어그레시브 모드
- 메인 모드와 마찬가지로 ISAKMP SA 생성에 사용된다.
- 이니시에이터와 리스폰더가 1.5 왕복 패킷을 교환하는 것으로 ISAKMP SA 가 작성된다.

1. 이니시에이터가 ISAKMP 파라메터, DH 공개값, ID, 인증용난수를 전송
메인 모드와는 다르게, *비밀대칭키를 생성하기 전에 최소의 패킷으로 ID를 전송하기 때문에, 암호화되지 않는다.*

2. 리스폰더가 수락한 파라메터, DH 공개값, ID, 인증용 난수, 인증용 해시값을 전송
이 것으로 이니시에이터와 리스폰더가 DH비밀키를 공유하고, 메인모드와 같이 4개의 비밀대칭키를 생성한다.

3. 이니시에이터가 인증용 해시값을 리스폰더에게 전송
이 것으로 리스폰더는 이니시에이터를 인증하고 ISAKMP SA 가 확립된다. 

어그레시브 모드로 사전공유키 인증을 할 경우, ID는 암호화되지 않지만 최초에 송신되기 때문에 *ID에 FQDN 등을 사용해서 사전공유키와 대응시키는 것이 가능하다.*
그 덕분에 IP 주소가 동적으로 설정되는 모바일 환경등에서도 사용하는 것이 가능하다. 
또한, IKEv2에서는 메인모드, 어그레시브 모드가 통합되어 동적으로 설정된 IP주소에도 사용가능하다. 

=> 즉, 간단히 말하면 메인모드에서는 IP를 기준으로 상대를 특정하기 때문에 IP가 바뀌는 환경에서는 사용할 수 없고, 어그레시브 모드에서는 사용자 ID를 기준으로 상대를 특정하기 때문에 IP가 바뀌는 환경에서도 사용할 수 있다는 말이군. 메인모드에서는 ID가 나중에(세번째 상대방 인증단계에서) 교환되고 어그레시브모드에서는 ID가 가장 먼저 교환되는 특징 때문에 나타난 결과이기도 하고.




**** 퀵 모드


** 리모트 접속에 있어서의 유의점 및 대책
*** 단말기기 부정사용에의 대책


*** IP주소의 동적 할당


*** NAT, NAPT를 사용할 때의 유의점


* 궁금점
** IPSec을 구성하는 하드웨어는?
- 서버가 될 수도 있고, FW끼리도 가능하다. 
