

* SMTP 취약점
전 세계 전자메일의 80%는 스팸 메일. 아래의 1, 2번 취약점 때문에 스팸 메일이 횡행하고 있음. 


1. 메일 투고와 중계가 같은 구조로 이루어짐
2. 메일 투고시에 사용자를 인증하는 절차가 없음
- 제 3자 중계 (= 오픈 릴레이) : 필요없는 조직 외에서 온 메일도 중계해버리는 것. 
- 오픈 릴레이 서버는 RBL.jp (Realtime Blackhole List Japan)등에 등록됨

3. 표준 메일 암호화 기능이 없기때문에, 평문으로 네트워크 상을 흘러다님
4. MTA의 구현/설정 문제로 유저 정보가 노출될 가능성이 있음
VRFY, EXPN 등의 명령으로 유저 정보 존재 여부 등 확인
5. MTA의 종류/버전 문제로 BOF 공격을 받을 가능성이 있음 (구 버전 소프트웨어 등)

※ 여기서, 투고는 클라이언트에서 SMTP서버로 메일을 전송하는 것을 말함. 

* STMP 취약점 대책
1. MTA에 발신자 메일 주소제한 설정걸기
- 송신자 주소가 자신의 도메인인 경우만 허용
- 수신자 주소가 자신의 도메인인 경우만 허용

2. SMTP Authentication (SMTP-AUTH)로 사용자를 인증
- MTA, MUA 양쪽이 이 인증방식을 적용해야 사용 가능
- 인증메커니즘으로 SASL(Simple Authentication and Security Layer)를 사용
- SASL은 유저명과 패스워드를 안전히 전송하는 수단으로서  Kerberos, GSSAPI, S/Key를 규정하고 있음.

3. POP before SMTP 로 사용자 인증
- 메일 송신전에 POP3에의한 유저 인증을 실시하고, 성공하면 일정기간 동안 메일 송신을 허가하는 방식
- SMTP서버는 POP서버가 보증해준 클라이언트 IP를 보고 허가

4. Outbound Port25 Blocking 으로 메일 투고 제한을 걸기
- 오픈 릴레이가 안통하게 되자 클라이언트를 감염시킨 후 직접 외부 메일서버와 송신을 시도하는 경우가 생김
- ISP의 메일서버를 경유하지 않고, 직접 인터넷으로 나가려고하는 25번 포트(SMTP)로의 패킷을 차단하는 방식
- 정상적인 경우는 메일투고시 submission 전용포트(587)을 사용함 (MSA가 접수를 담당)
- MSA는 SMTP-AUTH로 유저인증을 실시

5. IP주소, 디지털 서명으로 도메인 인증하기
송신 도메인이 정당한지 인증하는 방식임
1) IP 주소를 사용하는 방식
- Sender Policy Framework (SPF)
미리 발신자 DNS 서버에 정당한 메일 서버 IP주소 (SPF 레코드)를 등록해 두는 것으로 메일 서버를 인증하는 방식. 수신측 메일 서버는 해당 도메인의 DNS서버에게 메일 서버의 정보를 문의함. 문의결과 정당성이 확인되면 메일을 수신.

- Sender ID Framework (Sender ID)

- 장점 : 도입용이, 수신측 메일 서버 부담 적음, 송신측 메일서버는 아무것도 하지 않아도 됨. 
- 단점 : 발신자 주소를 위조하지 않은 스팸은 제거 불가능. DNS 서버에 등록되지 않은 메일서버로부터의 메일은 정당하더라도 수신 불가능, 복수의 메일서버를 경유한 메일을 검증하기 어려움. 

2) 디지털 서명을 사용하는 방식
- DomainKeys
미리 발신자 DNS 서버에 정당한 메일 서버의 공개키를 등록해둠.
발신자 메일 서버는 자신의 비밀키를 사용해 메일에 서명.
메일을 수신한 메일서버는 발신용 DNS 서버에 문의해 발신자 메일 서버의 공개키를 획득해서 서명의 정당성 확인


- DomainKeys Identified Mail (DKIM)
DomainKeys방식에 IIM방식을 결합한 IETF 표준.
공개키를 메일헤더에 삽입한다. 

- 장점 : 발신자 정보의 위조를 송신경로 상에서 탐지 가능, 복수의 메일 서버를 경유해도 검증 가능. 
- 단점 : 송신측, 수신측이 모두 이 방식을 지원해야 함. 양측 메일 서버의 부담이 커짐, 메일링 리스트나 광고등이 삽입되는 메일등 송신경로 상에서 내용이 변경되는 경우 검증이 어려움. 

6. 메일 필터링
- 메일 필터링 소프트웨어를 사용
- IP나 포함된 문자열등으로 필터링. 문자열 패턴이 조금 바뀌면 필터링이 안되는 문제가 있음. 
- 이 문제를 해결하기 위해 베이지안 필터링이 있음. 
- 스팸 메일의 특성을 자기학습해서 통계에 기반해서 필터링 하는 것. 

7. SMTP over TLS 로 메일 암호화 및 사용자 인증하기
- TLS를 이용해서 SMTP 통신을 암호화
- 암호화되는 구간은 MUA부터 해당 도메인의 SMTP 서버까지. 인터넷상에서는 평문으로 통신. 

8. S/MIME, PGP 등으로 메일 암호화하기
- 모든 통신 경로상에서 메일을 암호화 할 수 있음. 

9. MTA에서 불필요한 커맨드 무효화하기


10. 기타 MTA 구현 상의 대책
- MTA 버전 최신화
- 안티 바이러스 SW로 메일에 첨부된 바이러스 탐지
- 인터넷과 내부 네트워크 사이 DMZ에 메일 중계 서버를 설치
- 사내 랜에 POP3겸SMTP설치
- DMZ에 게이트웨이형 안티바이러스 서버 설치

* POP3 취약점
1. 인증정보가 평문으로 네트워크를 흘러다님
2. 수신 데이터(메일)가 평문으로 네트워크를 흘러다님


* POP3 취약점 대책
1. APOP 로 유저 인증정보 숨기기
- Authenticated Post Office Protocol
- 챌린지-리스폰스 방식의 유저 인증(일회성 인증)
- 서버로부터 받은 문자열(챌린지)를 패스워드와 결합해 MD5로 메세지 다이제스트를 생성, 그 것을 서버로 전송
- 패스워드 자체가 네트워크에서 흘러다닐 일은 없게 된다. 

2. POP3 over TLS로 인증정보 및 메일 암호화
- TLS를 이용해서 POP3 통신을 암호화
- 암호화되는 구간은 MUA와 POP3서버만이다.
- 995번 포트를 사용

3. SSH의 포트포워딩 기능으로 인증정보 및 메일 암호화
- 암호화되는 구간은 MUA와 POP3서버만이다.
- 암호화 기능이 없는 통신 구간에 SSH가 개입해서 통신을 중계함으로서 암호화 기능을 구현하는 것. 
- 이 경우는 통신 포트가 22번이 된다. 
