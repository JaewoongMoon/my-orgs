<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Understanding ysoserial's CommonsCollections1 exploit</title>
<!-- 2018-01-24 수 11:40 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Understanding ysoserial's CommonsCollections1 exploit</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. An Overview</a></li>
<li><a href="#sec-2">2. Pre-requisities</a></li>
<li><a href="#sec-3">3. Payload Only Execution</a></li>
<li><a href="#sec-4">4. Putting it all together</a></li>
<li><a href="#sec-5">5. Ref</a></li>
</ul>
</div>
</div>
<p>
Last year(2015), ysoserial was released by frohoff and gebl. It is a fantastic piece of work. The tool provides options to generate several different types of serialized objects, which when deserialized, can result in arbitrary code execution if the right classes are present in the classpath. In this post, I will discuss the CommonsCollections1 exploit, and its working, available in the ysoserial toolkit. 
</p>

<p>
<b>All code snippets used in this post are sourced from ysoserial</b>
</p>


<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> An Overview</h2>
<div class="outline-text-2" id="text-1">
<p>
The CommonsCollections1 exploit builds a custom AnnotationInvocationHandler object that contains an InvokerTransformer (Apache Commons Collections class)payload, and outputs the serializaed object. When the serialized object is deserialized, the code path from AnnotationInvocationHandler's readObject leads to InvokerTransformer's payload, causing code execution.
</p>

<p>
The image below shows the custom AnnotationInvocationHandler object used for RCE.
</p>

<p>
When the serialized object is deserialized, the code path from AnnotationInvocationHandler's readObject leads to Invoker Transformer's payload, causing code execution.
</p>

<p>
The image below shows the custom AnnotationInvocationHandler object used for RCE.
</p>

<div class="figure">
<p><img src="./img/Serialized_Object_Structure.png" alt="Serialized_Object_Structure.png" />
</p>
<p><span class="figure-number">Figure 1:</span> The serialized AnnotationInvocationHandler</p>
</div>

<p>
What makes the exploit effective is that it only relies on the classes present in Java and Apache Commons Collections. The CommonsCollections1 leverages following classes from JDK and Commons Collections. 
</p>

<p>
<b>From JDK</b>
</p>
<p class="verse">
1. AnnotationInvocationHandler<br  />
2. Proxy<br  />
3. Map<br  />
4. Override<br  />
5. InvocationHandler<br  />
6. Runtime<br  />
</p>

<p>
<b>From Commons Collections</b>
</p>
<p class="verse">
1. LazyMap<br  />
2. Transformer<br  />
3. ChainedTransformer<br  />
4. InvokerTransformer<br  />
</p>

<p>
So, as long a Java software stack contains Apache commons Collections library(&lt;= 3.2.1), it will be vulnerable to remote execution attacks while deserializing untrusted objects. 
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Pre-requisities</h2>
<div class="outline-text-2" id="text-2">
<p>
It will be helpful to refer to the following Classes and concepts as we work our way to understaing the exploit. 
</p>

<p class="verse">
1. Java Serialzation and Deserialization mechanisms<br  />
2. <font color="red">ObjectInputStream</font> - including readObject()<br  />
3. <font color="red">Proxy</font><br  />
4. <font color="red">InvocationHandler</font><br  />
5. <font color="red">Transformer</font><br  />
6. <font color="red">LazyMap</font><br  />
7. <font color="red">ChainedTransformer</font><br  />
8. <font color="red">InvokerTransformer</font> - Instances of this class were used to perform code execution and we will discuss this in more details below.<br  />
</p>

<p>
Since InvokerTransformer class is the eventual sink that performs code execution, lets us take a closer look at it. An InvokerTransformer constructor takes three parameters:
</p>
<p class="verse">
1. Name of the method<br  />
2. Parameter types the method accepts<br  />
3. Parameters values<br  />
</p>


<div class="figure">
<p><img src="./img/InvokerTransformer-constructor.png" alt="InvokerTransformer-constructor.png" />
</p>
<p><span class="figure-number">Figure 2:</span> The constructor of InvokerTransformer</p>
</div>

<p>
An InvokerTransformer instance accepts an object as input and outputs the transformed object. The tranformation is determined by the instatiation parameters. The InvokerTransformer first finds a method with the method name (specified as first parameter) that accepts the given parameters types (specified as second paramter) on the incoming object. Upon finding a matching method, the method on the incoming object and the parameter values from (3) as passed arguments into the method. The returned value is the value of the method execution. 
</p>


<div class="figure">
<p><img src="./img/InvokerTransformer.png" alt="InvokerTransformer.png" />
</p>
<p><span class="figure-number">Figure 3:</span> Shows InvokerTransformer</p>
</div>
</div>
</div>


<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Payload Only Execution</h2>
</div>


<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Putting it all together</h2>
</div>







<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Ref</h2>
<div class="outline-text-2" id="text-5">
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2018-01-24 수 11:40</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.5.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
