* Goal
1) To Understand why vulnerable.
2) To Think how can we check that an application is vulnerable or not. 

* Postulation
What is PHP FPM ? And When does it used?
And How we know an application used that?

* INTRODUCTION
The application may be forced to open arbitrary files and/or network resources.
Exploiting XXE issues on PHP applications may also lead to denial of service or
in some cases lead to command execution. 

* Description

#+BEGIN_SRC php
  public static function scan($xml, DOMDocument $dom = null)
  {
      if (self::isPhpFpm()){
          self::heuristicScan($xml);
      }
      // libxml_disable_entity_loader :
      // 외부 리소스를 불러오지 못하게 한다.
      // libxml_use_internal_errors :
      // XML 파싱 도중 오류가 발생하였을 경우, 오류 메세지를 출력하지 않는다.
      if(!self::isPhpFpm()){
          $loadEntities = libxml_disable_entity_loader(true);
          $useInternalXmlErrors = libxml_use_internal_errors(true);
      }

      // Load XML with network access disabled (LIBXML_NONET)
      $result = $dom->loadXml($xml, LIBXML_NONET);
      restore_error_handler();

      if(!self::isPhpFpm()){
          libxml_disable_entity_loader($loadEntities); 
          libxml_use_internal_errors($useInternalXmlErrors);
      }

      if (!$result){
          return false;
      }

      // Scan for potential XEE attacks using ENTITY, if not PHP-FPM
      if (!self::isPhpFpm()){
          foreach ($dom->childNodes as $child){
              if ($child->nodeType === XML_DOCUMENT_TYPE_NODE){
                  if ($child->entities->length >0){
                      require_once 'Exception.php';
                      throw new Zend_Xml_Exception(self::ENTITY_DETECT);
                  }
              }
          }
      }

      if (isset($simpleXml)){
          $result = simplexml_import_dom($dom);
          if (!$result instanceof SimpleXmlElement){
              return false;
          }
          return $result;
      }
      return $dom;

      

              
#+END_SRC

* 참고
https://beistlab.files.wordpress.com/2015/01/grayhash_intro_xxe.pdf
https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-5161
https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing
http://hyunmini.tistory.com/66

