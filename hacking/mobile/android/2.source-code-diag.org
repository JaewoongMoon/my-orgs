#+TITLE: 소스코드(APK) 진단 

* 개요
- 안드로이드 계열의 어플리케이션 파일은 apk 확장자이다.
- APK 파일안에는 컴파일된 프로그램 소스코드와 리소스 파일이 포함되어 있다. 
- 이 APK 파일을 조작해서 공격자에게 유리한 대로 사용할 수 있는지를 체크하는 것이 주목적이다. 

** 체크 포인트 
*** 프로그램 난독화 여부 
- JNI 사용여부 체크방법 : native, System.loadLibrary,JNIEnv, jobject 등의 키워드로 검색해본다. 

*** 중요정보 하드코딩
- 내부에 중요한 정보 (암호 키 등) 가 하드코딩 되어 있는지 체크한다. 
- SHA1, AES, MD5, key , security,  cipher, personal, decrypt  등과 같은 키워드로 검색해 본다. 

*** 시큐어 코딩이 되어 있지 않는 코드
- 취약한 코드를 찾는다. (SQL Injection 가능성 등) 


* 준비단계
APK 파일을 에뮬레이터에서 PC 환경으로 복사해야 한다. 

** APK을 PC로 복사하기
file:get-apk-from-emulator.org


* 앱 파일 구조 확인  
** 압축 풀기 
PC 에 APK 를 복사했다면 가장 먼저 APK파일의 압축을 풀어 본다. apk 파일은 기본적으로 압축 파일 포맷이다. 그 증거로 압축프로그램으로 apk 파일을 열어보면 내부에 있는 파일들이 보인다. 
압축을 한번 풀어본다. 
- properties 파일과 텍스트 파일들의 내용을 볼 수 있다. 
- 그러나 가장 중요한 소스코드는 classes.dex 파일로 되어 있어 볼 수 없고, 리소스 파일도 resources.arsc 파일로 되어 있어서 내용을 볼 수가 없다.
- 또한, 매니페스트 파일(AndroidManifest.xml) 파일도 암호화 처리가 되어 볼 수 없는 xml 파일로 변해 있다. 
- 소스 코드의 내용을 보려면 '디컴파일러' 라는 특별한 프로그램이 필요하다. 

* 리소스 정보 확인
리소스 파일중에서도 주로 매니페스트 파일(프로젝트 설정 파일)을 확인한다. 
매니페스트 파일에서 확인해야 할 것은 다음 두 가지이다. 
- debuggable=true 로 설정되어 있는가? true일 경우 동적 디버깅이 가능하므로 취약한 것으로 보고한다.
- 앱이 필요 최소한의 권한을 요구하고 있는가?

** AAPT (Android Asset Packaging Tool)
file:aapt.org

** 매니페스트 파일 권한 확인
개별 어플리케이션에는 AndroidManifest.xml 파일에 해당 어플리케이션이 할 수 있는 작업을 기술할 수 있다.

대략 다음과 같은 것들이 있다. 

| 이름                   | 설명                                                               |
|------------------------+--------------------------------------------------------------------|
| INTERNET               | 인터넷에 접속할 수 있다.                                           |
| READ_CONTACT           | 유저의 전화번호부 데이터를 읽을수 있다.                            |
| WRITE_CONTACT          | 유저의 전화번호부 데이터에 쓸 수 있다.                             |
| RECEIVE_SMS            | 수신받는 SMS를 모니터링 한다.                                      |
| ACCESS_COARSE_LOCATION | 중계국이나 wifi 같은 정밀도가 떨어지는 위치 프로바이더를 사용한다. |
| ACCESS_FINE_LOCATION   | 	GPS 같은 정확한 위치 프로바이더를 사용한다.                                                                   |


* 소스코드 확인
소스코드를 확인하기 위해서 디컴파일 과정을 거친다.  
안드로이드의 기본 개발 언어는 자바이다. 따라서 apk파일은 내부적으로 많든 적든 자바가 쓰였다고 생각할 수 있다. 따라서 가장 먼서 자바 코드를 확인해 본다. 

apk 파일을 디컴파일하는데 쓰이는 도구는 dex2jar, jd 이다. apktool은 apk 재패키징과 어셈블리 코드 획득에 필요하다. 

디컴파일 구조도는 다음과 같다. apk 파일에서 자바 소스 코드를 뽑아내려면 두 단계를 거친다. dex2jar를 사용해서 dex파일을 class파일로 변환한 후, jd를 사용해서 class파일을 java 로 변환하면 된다. 

#+CAPTION: java 디컴파일 과정 구조도
[[./img/3-java-decompile-1.png]]

이어서 각 툴의 설치방법과 사용방법에 대해 설명하겠다. 

** dex2jar
file:dex2jar.org

** jd
file:jd.org

** apktool
file:apktool.org

** C# 코드 분석
file:c-sharp-code-diag.org

** C++ 코드 분석
C#코드가 없고 대신 /lib/armeabi-v7a 에 so 파일들이 있는 경우가 있다. 이 경우는 il2cpp 를 사용해서 C++ 코드로 변환한 것이다. 

il2cpp 를 사용한 경우 볼 수 있는 파일은 다음과 같다. 

| file name            | description                  |
|----------------------+------------------------------|
| libcri_ware_unity.so | ?                            |
| libil2cpp.so         | 어플리케이션(게임) 소스 코드 |
| libmain.so           | 아마도 메인? 용량은 작다.    |
| libunity.so          | 유니티 라이브러리로 추정     |


il2cpp 에 대한 자세한 내용은 다음 문서를 참조한다. 
file:il2cpp.org



** 기타
- CodePro Analytix 라는 구글에서 제공하는 무료 툴이 있다고 한다. 
- 하지만 현재 왜인지 다운로드가 안됨. 
- 안드로이드 스튜디오에 Mint 랑 Firebase 라는 것이 있는데 아마 여기로 통합된 듯...
- 원본 소스 없이 역컴파일한 상태로는 정적분석 툴을 돌리는 것은 안되는 것 같다. (2016.11. 24 확인)


* 소스 코드 보호 방법
file:how-to-protect-source-code.org
